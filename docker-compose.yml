version: '3.8'

services:
    wechat-scheduler:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: wechat-scheduler
        restart: unless-stopped
        environment:
            - NODE_ENV=production
            - LOG_LEVEL=info
        env_file:
            - .env
        volumes:
            - ./logs:/app/logs
        ports:
            - '3000:3000'
        healthcheck:
            test: ['CMD', 'node', 'healthcheck.js']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        networks:
            - wechat-network

    # 可选：添加Redis用于会话存储
    redis:
        image: redis:7-alpine
        container_name: wechat-scheduler-redis
        restart: unless-stopped
        ports:
            - '6379:6379'
        volumes:
            - redis_data:/data
        networks:
            - wechat-network
        command: redis-server --appendonly yes

    # 可选：添加监控服务
    prometheus:
        image: prom/prometheus:latest
        container_name: wechat-scheduler-prometheus
        restart: unless-stopped
        ports:
            - '9090:9090'
        volumes:
            - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
            - prometheus_data:/prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.console.libraries=/etc/prometheus/console_libraries'
            - '--web.console.templates=/etc/prometheus/consoles'
            - '--storage.tsdb.retention.time=200h'
            - '--web.enable-lifecycle'
        networks:
            - wechat-network

    # 可选：Grafana用于监控面板
    grafana:
        image: grafana/grafana:latest
        container_name: wechat-scheduler-grafana
        restart: unless-stopped
        ports:
            - '3001:3000'
        environment:
            - GF_SECURITY_ADMIN_PASSWORD=admin123
        volumes:
            - grafana_data:/var/lib/grafana
        networks:
            - wechat-network

networks:
    wechat-network:
        driver: bridge

volumes:
    redis_data:
    prometheus_data:
    grafana_data:
